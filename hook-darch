#!/usr/bin/ash
# darch initcpio runtime hook
# This runs during early boot to set up the arch-atomic root filesystem

# Print immediately when hook is sourced (to stdout, which goes to console)
echo ":: DARCH HOOK FILE LOADED"

run_hook() {
    # Print to stdout immediately
    echo "========================================"
    echo ":: DARCH HOOK IS RUNNING!"
    echo "========================================"

    # Override mount_handler to use our custom mounting logic
    mount_handler=darch_mount_handler

    echo ":: darch: Registered custom mount handler"
    msg ":: darch: Registered custom mount handler"
}

darch_mount_handler() {
    # This function is called by init to mount the root filesystem at /new_root
    local new_root="${1:-/new_root}"

    echo ":: darch: Starting arch-atomic boot setup"
    msg ":: darch: Starting arch-atomic boot setup"

    # Parse kernel command line for our parameters
    local gen btrfs_uuid rootflags
    for param in $(cat /proc/cmdline); do
        case "$param" in
            root=UUID=*)
                btrfs_uuid="${param#root=UUID=}"
                msg ":: darch: Found root UUID: ${btrfs_uuid}"
                ;;
            rootflags=*)
                rootflags="${param#rootflags=}"
                msg ":: darch: Found rootflags: ${rootflags}"
                ;;
        esac
    done

    # Extract generation from rootflags (e.g., subvol=@images/gen-1)
    if [ -n "$rootflags" ]; then
        gen=$(echo "$rootflags" | sed 's/.*subvol=@images\/gen-\([0-9]*\).*/\1/')
        msg ":: darch: Detected generation: ${gen}"
    fi

    if [ -z "$btrfs_uuid" ] || [ -z "$gen" ]; then
        err "darch: Failed to parse boot parameters!"
        err "  btrfs_uuid=${btrfs_uuid}"
        err "  gen=${gen}"
        return 1
    fi

    # Wait for the btrfs device to appear
    msg ":: darch: Waiting for device with UUID ${btrfs_uuid}..."
    local device="/dev/disk/by-uuid/${btrfs_uuid}"
    local timeout=10
    while [ ! -b "$device" ] && [ $timeout -gt 0 ]; do
        sleep 1
        timeout=$((timeout - 1))
    done

    if [ ! -b "$device" ]; then
        err "darch: Timeout waiting for device ${device}"
        return 1
    fi
    msg ":: darch: Found device: ${device}"

    # Mount the btrfs root temporarily
    msg ":: darch: Mounting btrfs filesystem..."
    mkdir -p /mnt/btrfs
    if ! mount -t btrfs -o ro "$device" /mnt/btrfs; then
        err "darch: Failed to mount btrfs filesystem"
        return 1
    fi
    msg ":: darch: Btrfs mounted successfully"

    # Verify the generation exists
    if [ ! -d "/mnt/btrfs/@images/gen-${gen}" ]; then
        err "darch: Generation ${gen} not found in @images!"
        umount /mnt/btrfs
        return 1
    fi
    msg ":: darch: Generation ${gen} verified"

    # Create tmpfs root
    msg ":: darch: Setting up tmpfs root..."
    if ! mount -t tmpfs -o size=2G tmpfs "$new_root"; then
        err "darch: Failed to create tmpfs root"
        umount /mnt/btrfs
        return 1
    fi
    msg ":: darch: Tmpfs root created"

    # Create directory structure on tmpfs
    msg ":: darch: Creating directory structure..."
    mkdir -p "$new_root"/{dev,proc,sys,run,tmp,mnt,efi}
    mkdir -p "$new_root"/{images,var,home}
    chmod 1777 "$new_root/tmp"

    # Mount btrfs subvolumes into new root
    msg ":: darch: Mounting btrfs subvolumes..."
    mount -t btrfs -o subvol=@images,ro "$device" "$new_root/images"
    mount -t btrfs -o subvol=@var,rw "$device" "$new_root/var"
    mount -t btrfs -o subvol=@home,rw "$device" "$new_root/home"
    msg ":: darch: Subvolumes mounted"

    # Create symlinks to generation
    msg ":: darch: Creating symlinks to generation ${gen}..."
    ln -s /images/gen-${gen} "$new_root/current"
    ln -s /current/usr "$new_root/usr"
    ln -s /current/etc "$new_root/etc"
    ln -s /current/boot "$new_root/boot"
    ln -s usr/bin "$new_root/bin"
    ln -s usr/lib "$new_root/lib"
    ln -s usr/lib "$new_root/lib64"
    ln -s usr/bin "$new_root/sbin"
    ln -s /home/root "$new_root/root"
    msg ":: darch: Symlinks created"

    # Unmount temporary btrfs mount
    umount /mnt/btrfs

    msg ":: darch: Setup complete! Root filesystem ready at $new_root"
}

# vim: set ft=sh ts=4 sw=4 et:
